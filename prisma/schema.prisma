// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}


model ProductCategory {
  product_category_id               Int  @unique            @id @default(autoincrement())
  product_category_slug String @db.VarChar(50) @unique
  product_category_name String @db.VarChar(50) @unique

  products Product[]
}

model Product {
  product_id               Int  @unique            @id @default(autoincrement())
  product_slug             String @db.VarChar(70) @unique
  product_name             String @db.VarChar(70) @unique
  product_description      String @db.VarChar(2000) 
  product_category ProductCategory @relation(fields: [product_category_id], references: [product_category_id])
  product_category_id      Int
  product_discounts ProductDiscount[] @relation(name: "ProductToProductDiscount")
  product_iterations  ProductIteration[] @relation(name: "ProductToProductIteration")
}

model ProductIteration {
  product_iteration_id             Int   @unique         @id @default(autoincrement())
  product_variant_weight         Int  // max 500.000 gram / 500 kg
  product_variant_price          Int            @db.UnsignedMediumInt
  product_variant_stock          Int            @db.UnsignedSmallInt
  product        Product        @relation(name: "ProductToProductIteration", fields: [product_id], references: [product_id])
  product_id     Int
  order_item     OrderItem[]    @relation(name: "OrderItemToProductVariant")
  iteration_images IterationImage[] @relation(name: "ProductVariantToVariantImage")
  product_variant_mapping ProductVariantMapping[]
}

model ProductVariantMapping {
  product_variant_mapping_id             Int    @unique        @id @default(autoincrement())
  product_iteration ProductIteration @relation(fields: [product_iteration_id], references: [product_iteration_id])
  product_iteration_id Int
  variant Variant @relation(fields: [variant_id], references: [variant_id])
  variant_id Int
  @@unique([product_iteration_id, variant_id])
}

model VariantType {
  varian_type_id             Int  @unique          @id @default(autoincrement())
  variant_type_name String @db.VarChar(30) @unique
  variants Variant[]
}

model Variant {
  variant_id             Int  @unique          @id @default(autoincrement())
  variant_slug String @db.VarChar(15) @unique
  variant_name String @db.VarChar(15) @unique
  varian_type VariantType @relation(fields: [varian_type_id], references: [varian_type_id])
  varian_type_id Int
  product_variant_mapping ProductVariantMapping[]
}

model IterationImage {
  iteration_image_id                 Int   @unique         @id @default(autoincrement())
  product_variant_image              String
  product_iteration    ProductIteration @relation(name: "ProductVariantToVariantImage", fields: [product_variant_id], references: [product_iteration_id])
  product_variant_id Int
}

model OrderItem {
  order_item_id                 Int  @unique           @id @default(autoincrement())
  order_item_name    String
  order_item_perunit_price Int
  order_item_quantity Int            @db.UnsignedSmallInt

  order              Order          @relation(name: "OrderToOrderItem", fields: [order_id], references: [order_id])
  order_id           String            @unique
  product_iteration    ProductIteration @relation(name: "OrderItemToProductVariant", fields: [product_variant_id], references: [product_iteration_id])
  product_variant_id Int            @unique
}

model Invoice {
  invoice_id       String    @id @unique @default(cuid())
  invoice_date     DateTime @default(now())
  transaction_date DateTime
  payment_date     DateTime
  customer_name    String   @db.VarChar(35)
  customer_address String   @db.VarChar(200)
  discount_amount  Int      @db.UnsignedMediumInt
  total_price      Int      @db.UnsignedMediumInt
  bill             Int      @db.UnsignedMediumInt
  order            Order    @relation(name: "InvoiceToOrder", fields: [order_id], references: [order_id])
  order_id         String      @unique
  invoice_item InvoiceItem[]
}

model InvoiceItem {
  invoice_item_id Int @id @default(autoincrement()) @unique
  invoice_item_quantity Int            @db.UnsignedSmallInt
  invoice_item_name String
  invoice_item_weight Int
  invoice_perunit_price Int            @db.UnsignedMediumInt
  invoice_item_total_price Int         @db.UnsignedMediumInt
  invoice_item_description String
   

  invoice Invoice @relation(fields: [invoice_id], references: [invoice_id])
  invoice_id String
}


model Order {
  order_id          String    @id @unique @default(cuid())
  order_date  DateTime    @default(now())
  order_status String @db.VarChar(50)
  discount_amount Int      @db.UnsignedMediumInt

  order_items  OrderItem[] @relation(name: "OrderToOrderItem")
  guest_order GuestOrder? @relation(name: "GuestOrderToOrder")
  invoice     Invoice?    @relation(name: "InvoiceToOrder")
  shipment Shipment?
  payment Payment?
}

model Payment {
  payment_id                     String    @id @unique @default(cuid())
  paygate_transaction_id String // tripay transaction reference code
  payment_date           DateTime
  payment_method         String
  total_payment          Int      @db.UnsignedMediumInt

  order Order @relation(fields: [order_id], references: [order_id])
  order_id String @unique
}

model Shipment {
  shipment_id                  String    @id @unique @default(cuid())
  expedition_order_id String // biteship order id
  shipment_date       DateTime
  courier Courier @relation(fields: [courier_id], references: [courier_id])
  courier_id Int 

  order Order @relation(fields: [order_id], references: [order_id])
  order_id String @unique
}

model Courier {
  courier_id        Int  @unique     @id @default(autoincrement())
  courier_name String
  courier_code String
  courier_service_name String
  courier_service_code String

  shipments Shipment[]
  @@unique([courier_code, courier_service_code])
}


model GuestOrder {
  guest_order_id           Int @unique   @id @default(autoincrement())
  order_code         String    @unique @default(cuid())
  guest_full_name    String @db.VarChar(35)
  guest_phone_number String @db.TinyText
  guest_email        String @db.VarChar(75)
  guest_address      String   @db.VarChar(200)
  order        Order  @relation(name: "GuestOrderToOrder", fields: [order_id], references: [order_id])
  order_id     String    @unique
}

model Discount {
  discount_id                           Int      @unique              @id @default(autoincrement())
  discount_code                String
  discount_value               Int                    @db.UnsignedMediumInt
  is_percent_discount          Boolean
  maximum_discount_amount      Int                    @db.UnsignedMediumInt
  is_limited                   Boolean
  usage_limits                 Int                    @db.UnsignedSmallInt
  number_of_uses               Int                    @db.UnsignedSmallInt
  product_discount             ProductDiscount        @relation(name: "DiscountToProductDiscount", fields: [product_discount_id], references: [product_discount_id])
  product_discount_id          Int                    @unique
  threshold_discount           ThresholdDiscount      @relation(name: "DiscountToThresholdDiscount", fields: [threshold_discount_id], references: [threshold_discount_id])
  threshold_discount_id        Int                    @unique
  limited_time_discount        LimitedTimeDiscount    @relation(name: "DiscountToLimitedTimeDiscount", fields: [limited_time_discount_id], references: [limited_time_discount_id])
  limited_time_discount_id     Int                    @unique
  daily_discount               DailyDiscount          @relation(name: "DailyDiscountToDiscount", fields: [daily_discount_id], references: [daily_discount_id])
  daily_discount_id            Int                    @unique
}

model ThresholdDiscount {
  threshold_discount_id             Int   @unique    @id @default(autoincrement())
  minimum_amount Int       @db.UnsignedMediumInt
  discount       Discount? @relation(name: "DiscountToThresholdDiscount")
}

model LimitedTimeDiscount {
  limited_time_discount_id        Int   @unique    @id @default(autoincrement())
  from_date DateTime
  to_date   DateTime
  discount  Discount? @relation(name: "DiscountToLimitedTimeDiscount")
}

model DailyDiscount {
  daily_discount_id        Int  @unique     @id @default(autoincrement())
  from_hour DateTime  @db.Time()
  to_hour   DateTime  @db.Time()
  discount  Discount? @relation(name: "DailyDiscountToDiscount")
}

model ProductDiscount {
  product_discount_id         Int   @unique     @id @default(autoincrement())
  product    Product    @relation(name: "ProductToProductDiscount", fields: [product_id], references: [product_id])
  product_id Int        @unique
  discount   Discount? @relation(name: "DiscountToProductDiscount")
}

model Admin {
  admin_id    String    @id @unique @default(cuid())
  admin_full_name        String @db.VarChar(35)
  admin_hashedPassword  String
  admin_email           String @db.VarChar(75)        @unique
  admin_created_at       DateTime      @default(now())
  sessions        Session[]
}

model Session {
  session_id           String    @id @unique @default(cuid())
  refresh_token String   @default(uuid()) @db.Text
  is_blocked    Boolean  @default(false)
  created_at    DateTime @default(now())
  expired_at    DateTime
  admin        Admin?   @relation(fields: [admin_id], references: [admin_id])
  admin_id      String?
}

